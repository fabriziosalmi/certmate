<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CertMate{% endblock %}</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link href="/static/css/fontawesome.min.css" rel="stylesheet">
    {% block head %}{% endblock %}
    <script>
    // Apply dark mode before paint to prevent flash
    (function() {
        var theme = localStorage.getItem('theme');
        if (theme === 'dark' || (theme !== 'light' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }
    })();
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-200">
    <!-- Navigation -->
    <nav class="bg-white dark:bg-gray-800 shadow-sm border-b dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <a href="/">
                            <img src="/static/img/certmate_logo_256.png" alt="CertMate" class="w-12 h-12">
                        </a>
                    </div>
                    <div class="ml-3">
                        <h1 class="text-xl font-semibold text-gray-900 dark:text-white">CertMate</h1>
                        <p class="text-sm text-gray-500 dark:text-gray-400">SSL Certificate Manager</p>
                    </div>
                </div>
                <div class="flex items-center space-x-1 sm:space-x-4">
                    <a href="/" class="px-3 py-2 rounded-md text-sm font-medium {% if request.path == '/' %}text-primary bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700{% else %}text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}">
                        <i class="fas fa-certificate mr-1"></i><span class="hidden sm:inline"> Certificates</span>
                    </a>
                    <a href="/#client" class="px-3 py-2 rounded-md text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-id-card mr-1"></i><span class="hidden sm:inline"> Client Certs</span>
                    </a>
                    <a href="/settings" class="px-3 py-2 rounded-md text-sm font-medium {% if request.path == '/settings' %}text-primary bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700{% else %}text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}">
                        <i class="fas fa-cog mr-1"></i><span class="hidden sm:inline"> Settings</span>
                    </a>
                    <a href="/help" class="px-3 py-2 rounded-md text-sm font-medium {% if request.path == '/help' %}text-primary bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700{% else %}text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}">
                        <i class="fas fa-question-circle mr-1"></i><span class="hidden sm:inline"> Help</span>
                    </a>
                    <!-- Notification bell -->
                    <div class="relative">
                        <button type="button" id="notifBtn" onclick="toggleNotifications()" class="px-2 py-2 rounded-md text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 relative" title="Notifications">
                            <i class="fas fa-bell"></i>
                            <span id="notifBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold">0</span>
                        </button>
                        <div id="notifPanel" class="hidden absolute right-0 mt-2 w-80 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 z-50 max-h-96 overflow-y-auto">
                            <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700">
                                <h3 class="text-sm font-semibold text-gray-900 dark:text-white">Notifications</h3>
                            </div>
                            <div id="notifList" class="py-2">
                                <p class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">No notifications</p>
                            </div>
                        </div>
                    </div>
                    <!-- Dark mode toggle -->
                    <button id="themeToggle" onclick="toggleTheme()" class="px-2 py-2 rounded-md text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700" title="Toggle theme">
                        <i class="fas fa-moon dark:hidden"></i>
                        <i class="fas fa-sun hidden dark:inline"></i>
                    </button>
                    <!-- Logout -->
                    <button id="logoutBtn" onclick="doLogout()" style="display:none" class="px-3 py-2 rounded-md text-sm font-medium text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30 border border-red-200 dark:border-red-700" title="Logout">
                        <i class="fas fa-sign-out-alt mr-1"></i><span class="hidden sm:inline"> Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>
    <script>
    // Auth check
    (function(){
        fetch('/api/auth/me',{credentials:'same-origin'})
            .then(function(r){return r.json()})
            .then(function(d){if(d&&d.username)document.getElementById('logoutBtn').style.display='inline-block';})
            .catch(function(){});
    })();
    function doLogout(){
        fetch('/api/auth/logout',{method:'POST',credentials:'same-origin'})
            .then(function(){window.location.href='/login'})
            .catch(function(){window.location.href='/login'});
    }
    // Theme toggle
    function toggleTheme(){
        var html = document.documentElement;
        if (html.classList.contains('dark')) {
            html.classList.remove('dark');
            localStorage.setItem('theme', 'light');
        } else {
            html.classList.add('dark');
            localStorage.setItem('theme', 'dark');
        }
    }
    // Notifications
    var _notifOpen = false;
    function toggleNotifications() {
        var panel = document.getElementById('notifPanel');
        _notifOpen = !_notifOpen;
        panel.classList.toggle('hidden', !_notifOpen);
    }
    document.addEventListener('click', function(e) {
        if (_notifOpen && !e.target.closest('#notifBtn') && !e.target.closest('#notifPanel')) {
            document.getElementById('notifPanel').classList.add('hidden');
            _notifOpen = false;
        }
    });
    function renderNotifications(certs) {
        if (!Array.isArray(certs)) return;
        var warnings = [];
        certs.forEach(function(c) {
            if (!c.exists) return;
            var days = c.days_until_expiry;
            if (days !== null && days !== undefined) {
                if (days <= 0) {
                    warnings.push({domain: c.domain, days: days, type: 'expired'});
                } else if (days <= 7) {
                    warnings.push({domain: c.domain, days: days, type: 'critical'});
                } else if (days <= 30) {
                    warnings.push({domain: c.domain, days: days, type: 'warning'});
                }
            }
        });
        var badge = document.getElementById('notifBadge');
        var list = document.getElementById('notifList');
        if (warnings.length === 0) {
            badge.classList.add('hidden');
            list.innerHTML = '<p class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400"><i class="fas fa-check-circle text-green-500 mr-2"></i>All certificates healthy</p>';
            return;
        }
        badge.textContent = warnings.length > 9 ? '9+' : warnings.length;
        badge.classList.remove('hidden');
        var html = '';
        warnings.sort(function(a, b) { return a.days - b.days; });
        warnings.forEach(function(w) {
            var icon, color, msg;
            if (w.type === 'expired') {
                icon = 'fa-times-circle'; color = 'text-red-500'; msg = 'Expired';
            } else if (w.type === 'critical') {
                icon = 'fa-exclamation-circle'; color = 'text-red-500'; msg = w.days + 'd left';
            } else {
                icon = 'fa-exclamation-triangle'; color = 'text-yellow-500'; msg = w.days + 'd left';
            }
            html += '<a href="/" class="block px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-700/50">' +
                '<div class="flex items-center gap-3">' +
                '<i class="fas ' + icon + ' ' + color + '"></i>' +
                '<div class="min-w-0 flex-1">' +
                '<p class="text-sm font-medium text-gray-900 dark:text-white truncate">' + CertMate.escapeHtml(w.domain) + '</p>' +
                '<p class="text-xs ' + color + '">' + msg + '</p>' +
                '</div></div></a>';
        });
        list.innerHTML = html;
        try { sessionStorage.setItem('cm_notif', JSON.stringify({t: Date.now(), d: certs})); } catch(e){}
    }
    function checkNotifications(force) {
        // Use cached data if fresh (< 60s) to avoid extra API calls
        if (!force) {
            try {
                var cached = JSON.parse(sessionStorage.getItem('cm_notif') || '{}');
                if (cached.t && (Date.now() - cached.t) < 60000) {
                    renderNotifications(cached.d);
                    return;
                }
            } catch(e){}
        }
        fetch('/api/certificates', {credentials: 'same-origin'})
            .then(function(r) { return r.ok ? r.json() : []; })
            .then(function(certs) { renderNotifications(certs); })
            .catch(function() {});
    }
    // Check on load (with cache) and refresh every 5 minutes
    setTimeout(checkNotifications, 2000);
    setInterval(function() { checkNotifications(true); }, 300000);
    </script>
    <script src="/static/js/htmx.min.js"></script>
    <script defer src="/static/js/alpine.min.js"></script>
    <script src="/static/js/certmate.js"></script>

    {% block content %}{% endblock %}

    {% block scripts %}{% endblock %}
</body>
</html>
